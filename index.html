<!DOCTYPE html>
<html lang="vi">
<head>
  <meta charset="utf-8"><meta name="viewport" content="width=device-width,initial-scale=1">
  <title>Tra cứu Q-Charge</title>
  <style>/* giữ nguyên như trước */</style>
</head>
<body>
  <h1>Tra cứu Q-Charge</h1>
  <label>Từ ngày:<input type="date" id="fromDate"></label>
  <label>Đến ngày:<input type="date" id="toDate"></label><br>
  <input id="input" placeholder="Nhập mã KH..." disabled>
  <button id="btnSearch" disabled>Tra cứu</button>
  <ul id="suggestions"></ul><div id="result"></div>

  <script>
    const API = 'https://script.google.com/macros/s/AKfycbwm62tqOXFRk4oxEhIvmQljeowij3l06e5cteJ6qbf1/exec';
    // thiết lập ngày mặc định…
    const fd=document.getElementById('fromDate'), td=document.getElementById('toDate');
    (()=>{
      const n=new Date(), y=n.getFullYear(), m=('0'+(n.getMonth()+1)).slice(-2), d=('0'+n.getDate()).slice(-2);
      fd.value=`${y}-${m}-01`; td.value=`${y}-${m}-${d}`;
    })();

    const inp=document.getElementById('input'), btn=document.getElementById('btnSearch'),
          ul=document.getElementById('suggestions'), res=document.getElementById('result');
    let timer;

    async function askPW(){
      while(true){
        let p=prompt('Nhập mật khẩu (mã KH):');
        if(!p) continue;
        p=p.trim().toUpperCase();
        const r=await fetch(`${API}?password=${encodeURIComponent(p)}`);
        const j=await r.json();
        if(!j.error) return;
        alert('Mật khẩu không hợp lệ!');
      }
    }

    (async()=>{
      await askPW();
      inp.disabled=false; btn.disabled=false;

      inp.addEventListener('input', ()=>{
        clearTimeout(timer);
        ul.innerHTML='';
        const q=inp.value.trim().toUpperCase();
        if(!q) return;
        timer=setTimeout(()=>fetchSuggest(q),300);
      });

      btn.addEventListener('click', ()=>{
        const code=inp.value.trim().toUpperCase();
        if(!code) return alert('Nhập mã KH!');
        fetchDetail(code);
      });
    })();

    async function fetchSuggest(q){
      ul.innerHTML='<li class="loading">Đang tải…</li>';
      const r=await fetch(`${API}?password=${encodeURIComponent(q)}&query=${encodeURIComponent(q)}`);
      const j=await r.json(); ul.innerHTML='';
      if(j.error){ ul.innerHTML=`<li class="loading">${j.error}</li>`; return; }
      (j.suggestions||[]).forEach(x=>{
        const li=document.createElement('li');
        li.textContent=`${x.code} – ${x.name}`;
        li.onclick=()=>{ inp.value=x.code; ul.innerHTML=''; fetchDetail(x.code); };
        ul.appendChild(li);
      });
      if(!(j.suggestions||[]).length) ul.innerHTML='<li class="loading">Không tìm thấy</li>';
    }

    async function fetchDetail(code){
      res.innerHTML='<p class="loading">Đang tải dữ liệu…</p>';
      const from=fd.value, to=td.value;
      const url=`${API}`
              +`?password=${encodeURIComponent(code)}`
              +`&id=${encodeURIComponent(code)}`
              +`&from=${from}&to=${to}`;
      const r=await fetch(url), j=await r.json();
      if(j.error){ res.innerHTML=`<p style="color:red">${j.error}</p>`; return; }
      const arr=j.data||[];
      if(!arr.length){ res.innerHTML='<p>Không có dữ liệu trong khoảng này.</p>'; return; }
      let html='<table><thead><tr>'
               +'<th>Ngày</th><th>cosφ</th><th>kWh</th><th>kVArh</th><th>Đơn giá</th><th>Tiền Q</th>'
               +'</tr></thead><tbody>';
      arr.forEach(r=>{
        const low=r.COSPHI<0.9;
        html+=`<tr class="${low?'low':''}">`
             +`<td>${r.DATE}</td><td>${r.COSPHI}</td><td>${r.KWh}</td><td>${r.KVArh}</td>`
             +`<td>${r.unitPrice.toLocaleString()}</td><td>${r.Q_CHARGE.toLocaleString()}</td>`
             +`</tr>`;
      });
      html+='</tbody></table>';
      res.innerHTML=html;
    }
  </script>
</body>
</html>

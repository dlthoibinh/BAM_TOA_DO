<!DOCTYPE html>
<html lang="vi">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width,initial-scale=1">
  <title>Thông Tin Trạm CC và CD</title>
  <style>
    body{font-family:Arial,sans-serif;margin:20px}
    h1{color:#004a99;margin-bottom:16px}
    input{width:100%;padding:10px;font-size:18px;border:1px solid #ccc;border-radius:5px;margin-bottom:10px}
    ul{list-style:none;padding:0;margin:0 0 20px;border:1px solid #ccc;border-radius:5px;max-height:200px;overflow-y:auto}
    li{padding:10px;border-bottom:1px solid #ddd;cursor:pointer}
    li:last-child{border-bottom:none}
    li:hover{background:#f0f0f0}
    .loading{text-align:center;color:#555;margin:10px 0}
    table{width:100%;border-collapse:collapse;margin-top:20px}
    th,td{padding:10px;border:1px solid #ddd;text-align:left}
    th{background:#e6f2ff;color:#004a99}
  </style>
</head>
<body>
  <h1>Thông Tin Trạm CC và CD</h1>
  <input id="input" placeholder="Nhập mã trạm hoặc tên trạm...">
  <ul id="suggestions"></ul>
  <div id="result"></div>

  <!-- CryptoJS MD5 -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/crypto-js/4.1.1/crypto-js.min.js"></script>
  <script>
    // THAY '‹YOUR_DEPLOY_ID›' bằng ID bạn lấy từ bước Deploy
    const API_URL = 'https://script.google.com/macros/s/AKfycbwsj0yT4UvIehpK7kdXOV4g4ghQKzhD3yGrVif_S-NLKd2zfGcbG4t15-iIGd3yC1H0YA/exec';

    // Lưu / đọc localStorage
    function savePW(h){ localStorage.setItem('pw', h) }
    function loadPW(){ return localStorage.getItem('pw') }

    // Hỏi mật khẩu MD5, kiểm tra với API
    async function askPW(){
      while(true){
        const pw = prompt('Vui lòng nhập mật khẩu:');
        if(!pw) continue;
        const hash = CryptoJS.MD5(pw).toString();
        const res  = await fetch(`${API_URL}?password=${hash}`);
        const j    = await res.json();
        if(res.ok && !j.error){
          savePW(hash);
          return hash;
        }
        alert('Mật khẩu không hợp lệ!');
      }
    }
    async function getPW(){
      return loadPW() || await askPW();
    }

    const inp  = document.getElementById('input');
    const ul   = document.getElementById('suggestions');
    const divR = document.getElementById('result');
    let debounce;

    inp.addEventListener('input',()=>{
      clearTimeout(debounce);
      ul.innerHTML='';
      if(!inp.value.trim()) return;
      debounce = setTimeout(()=> fetchSuggest(inp.value.trim()), 300);
    });

    async function fetchSuggest(q){
      ul.innerHTML = '<li class="loading">Đang tải...</li>';
      const pw = await getPW();
      const res = await fetch(`${API_URL}?query=${encodeURIComponent(q)}&password=${pw}`);
      const j   = await res.json();
      ul.innerHTML = '';
      const list = j.suggestions || [];
      if(!list.length) ul.innerHTML = '<li class="loading">Không tìm thấy</li>';
      list.forEach(x=>{
        const li = document.createElement('li');
        li.textContent = `${x.code} – ${x.name}`;
        li.onclick = ()=>{ inp.value=x.code; ul.innerHTML=''; fetchDetail(x.code) };
        ul.appendChild(li);
      });
    }

    async function fetchDetail(id){
      divR.innerHTML = '<p class="loading">Đang tải chi tiết…</p>';
      const pw = await getPW();
      const res = await fetch(`${API_URL}?id=${encodeURIComponent(id)}&password=${pw}`);
      const j   = await res.json();
      if(j.error){
        divR.innerHTML = `<p style="color:red">${j.error}</p>`;
        return;
      }
      let html = '<table><thead><tr><th>Thuộc tính</th><th>Giá trị</th></tr></thead><tbody>';
      Object.entries(j).forEach(([k,v])=>{
        html += `<tr><td>${k}</td><td>${v}</td></tr>`;
      });
      html += '</tbody></table>';
      divR.innerHTML = html;
    }
  </script>
</body>
</html>
